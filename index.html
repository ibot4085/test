<!DOCTYPE html>
<html lang="ckb" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سڕینەوەی زیرەکی شت لە وێنە</title>
    <!-- TensorFlow.js and BodyPix for AI capabilities -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@latest"></script>
    <!-- OpenCV.js -->
    <script async src="https://docs.opencv.org/4.5.5/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        /* هەموو ستایلەکانی پێشوو لێرەدا بمێننەوە */
        /* ... */
        
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- هەموو بەشەکانی HTML بمێننەوە -->
        <!-- ... -->
    </div>

    <script>
        // گۆڕاوەکانی سەرەتا
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const editorContainer = document.getElementById('editorContainer');
        const brushSizeSlider = document.getElementById('brushSize');
        const brushSizeValue = document.getElementById('brushSizeValue');
        const brushPreview = document.getElementById('brushPreview');
        const smartModeCheckbox = document.getElementById('smartMode');
        const removeBtn = document.getElementById('removeBtn');
        const undoBtn = document.getElementById('undoBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const aiEnhanceBtn = document.getElementById('aiEnhanceBtn');
        const aiPrecisionSlider = document.getElementById('aiPrecision');
        const aiPrecisionValue = document.getElementById('aiPrecisionValue');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const aiLoading = document.getElementById('aiLoading');

        let originalImage = null;
        let maskCanvas = null;
        let maskCtx = null;
        let isDrawing = false;
        let brushSize = 20;
        let smartMode = true;
        let aiPrecision = 70;
        let imageHistory = [];
        let customCursor = null;
        let lastDrawPoint = null;
        let aiModel = null;
        let isAILoading = false;
        let cvReady = false;

        // فەنکشنی بارکردنی OpenCV
        function onOpenCvReady() {
            cvReady = true;
            console.log('OpenCV.js بارکرا بە سەرکەوتوویی');
        }

        // فەنکشنەکانی تر بمێننەوە
        // ...

        // فەنکشنی نوێ بۆ سڕینەوە بە OpenCV
        async function removeSelectedAreas() {
            if (!maskCanvas) return;

            saveToHistory();
            showAILoading("AI کاردەکات لەسەر وێنەکە...");

            try {
                if (cvReady) {
                    await removeWithOpenCV();
                } else {
                    await removeWithTF();
                }
                
                updateProgress(100);
            } catch (error) {
                console.error("هەڵە لە سڕینەوە:", error);
                alert("هەڵە لە کاتی سڕینەوە بە یارمەتی AI");
            } finally {
                hideAILoading();
            }
        }

        async function removeWithOpenCV() {
            return new Promise((resolve) => {
                const img = cv.imread(canvas);
                const mask = cv.imread(maskCanvas);
                
                const grayMask = new cv.Mat();
                cv.cvtColor(mask, grayMask, cv.COLOR_RGBA2GRAY);
                
                const binaryMask = new cv.Mat();
                cv.threshold(grayMask, binaryMask, 10, 255, cv.THRESH_BINARY);
                
                const result = new cv.Mat();
                cv.inpaint(img, binaryMask, result, 3, cv.INPAINT_TELEA);
                
                cv.imshow(canvas, result);
                
                img.delete();
                mask.delete();
                grayMask.delete();
                binaryMask.delete();
                result.delete();
                
                resolve();
            });
        }

        async function removeWithTF() {
            const maskData = maskCtx.getImageData(0, 0, canvas.width, canvas.height);
            let segmentation = null;
            
            if (aiModel && smartMode) {
                segmentation = await aiModel.segmentPerson(canvas, {
                    flipHorizontal: false,
                    internalResolution: (aiPrecision > 70) ? 'high' : (aiPrecision > 40) ? 'medium' : 'low',
                    segmentationThreshold: aiPrecision / 100
                });
                updateProgress(50);
            }

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(canvas, 0, 0);
            
            await applyAIInpainting(tempCtx, maskData, segmentation);
            ctx.drawImage(tempCanvas, 0, 0);
            maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
        }

        // فەنکشنی نوێ بۆ باشترکردن بە OpenCV
        async function enhanceWithAI() {
            if (!originalImage || isAILoading) return;
            
            saveToHistory();
            showAILoading("باشترکردنی وێنە بە یارمەتی AI...");
            
            try {
                if (cvReady) {
                    await enhanceWithOpenCV();
                } else {
                    await enhanceWithBasic();
                }
                
                updateProgress(100);
                alert("وێنەکەت بە سەرکەوتوویی باشترکرایەوە بە یارمەتی AI!");
            } catch (error) {
                console.error("هەڵە لە باشترکردن:", error);
                alert("هەڵە لە باشترکردنی وێنە بە یارمەتی AI");
            } finally {
                hideAILoading();
            }
        }

        async function enhanceWithOpenCV() {
            return new Promise((resolve) => {
                const img = cv.imread(canvas);
                
                const gray = new cv.Mat();
                cv.cvtColor(img, gray, cv.COLOR_RGBA2GRAY);
                
                const edges = new cv.Mat();
                cv.Canny(gray, edges, 50, 150);
                
                const sharpened = new cv.Mat();
                cv.GaussianBlur(img, sharpened, new cv.Size(0, 0), 3);
                cv.addWeighted(img, 1.5, sharpened, -0.5, 0, sharpened);
                
                const lab = new cv.Mat();
                cv.cvtColor(sharpened, lab, cv.COLOR_RGBA2RGB);
                cv.cvtColor(lab, lab, cv.COLOR_RGB2Lab);
                
                const labPlanes = new cv.MatVector();
                cv.split(lab, labPlanes);
                
                const clahe = cv.createCLAHE(2.0, new cv.Size(8, 8));
                clahe.apply(labPlanes.get(0), labPlanes.get(0));
                
                cv.merge(labPlanes, lab);
                cv.cvtColor(lab, lab, cv.COLOR_Lab2RGB);
                cv.cvtColor(lab, lab, cv.COLOR_RGB2RGBA);
                
                cv.imshow(canvas, lab);
                
                img.delete();
                gray.delete();
                edges.delete();
                sharpened.delete();
                lab.delete();
                labPlanes.delete();
                clahe.delete();
                
                resolve();
            });
        }

        async function enhanceWithBasic() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            applyEnhancementFilter(imageData.data);
            ctx.putImageData(imageData, 0, 0);
        }

        // فەنکشنەکانی پێشوو بمێننەوە
        // ...

    </script>
</body>
</html>